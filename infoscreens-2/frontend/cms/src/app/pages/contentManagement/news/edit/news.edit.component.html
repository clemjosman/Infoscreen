<div class="page-container">
  <!-- TOP BACKGROUND -->
  <div class="top-bg accent"></div>

  <!-- HEADER -->
  <page-header
    [pathArray]="pathArray"
    [displayBreadcrumbBackButton]="false"
  ></page-header>

  <!-- NEWS FORM -->
  <div
    *ngIf="isNew !== undefined && news !== undefined"
    id="news-edit-container"
  >
    <div *ngIf="editNewsForm !== undefined">
      <form
        [formGroup]="editNewsForm"
        (ngSubmit)="onSubmit(editNewsForm.value)"
      >
        <!-- ACTIONS -->
        <div id="action-container">
       
          <button
            mat-raised-button
            [color]="editNewsForm.invalid ? 'disabled' : 'action'"
            type="submit"
            [disabled]="editNewsForm.invalid"
          >
            <mat-icon>save</mat-icon>
            {{ "general.button.save" | translate }}
          </button>
          <button
            mat-raised-button
            color="warning"
            type="button"
            (click)="cancelEdit()"
          >
            <mat-icon>reply</mat-icon>
            {{ "general.button.cancel" | translate }}
          </button>
          <button
            mat-raised-button
            color="danger"
            type="button"
            (click)="deleteNews()"
            *ngIf="!isNew"
          >
            <mat-icon>delete</mat-icon>
            {{ "news.delete" | translate }}
          </button>
        </div>

        <div class="column-container">
          <div id="news-edit-left-column">
            <mat-card id="multi-lingual-card">
              <mat-card-header>
                <mat-card-title>
                  {{ "label.multilingualContent" | translate }}
                </mat-card-title>
              </mat-card-header>
              <mat-divider [inset]="true"></mat-divider>
              <br />

              <!-- MULTILINGUAL PART -->
              <div
                formArrayName="multilingualContent"
                id="languages-content-container"
              >
                <mat-expansion-panel
                  *ngFor="
                    let multilingualContent of editNewsForm.get(
                      'multilingualContent'
                    ).controls;
                    let multilingualContentIndex = index
                  "
                  [formGroupName]="multilingualContentIndex"
                >
                  <mat-expansion-panel-header>
                    <mat-panel-title
                      [ngClass]="
                        editNewsForm.controls['multilingualContent'].controls[
                          multilingualContentIndex
                        ].invalid
                          ? 'mat-danger-content'
                          : ''
                      "
                    >
                      {{
                        multilingualContent.value.language.displayName[
                          _translationService.currentLanguage.value?.cultureCode
                        ]
                      }}
                      <button
                        mat-raised-button
                        smaller-button
                        color="danger"
                        *ngIf="
                          editNewsForm.get('multilingualContent').controls
                            .length > 1
                        "
                        class="button"
                        type="button"
                        (click)="
                          removeMultilingualFormItem(multilingualContentIndex)
                        "
                      >
                        <mat-icon>delete</mat-icon>
                        <span>{{ "general.button.delete" | translate }}</span>
                      </button>
                    </mat-panel-title>
                  </mat-expansion-panel-header>
                  <mat-divider [inset]="true"></mat-divider>
                  <br />

                  <!-- TITLE -->
                  <div class="title-container">
                    <mat-form-field>
                      <mat-label>{{ "label.title" | translate }} </mat-label>
                      <input
                        matInput
                        [id]="
                          'title-' + multilingualContent.value.language.iso2
                        "
                        type="text"
                        formControlName="title"
                      />
                    </mat-form-field>
                  </div>
                  <br />

                  <!-- CONTENT -->
                  <div class="content-container">
                    <mat-label>{{ "label.content" | translate }} </mat-label>
                    <!-- TEXT EDITOR -->
                    <div
                      [id]="'editor-' + multilingualContent.value.language.iso2"
                      [attr.multilingualContentIndex]="multilingualContentIndex"
                    ></div>
                    {{ "label.editorKeyboardShortcuts" | translate }}
                    <div class="editor-warning-message">
                      âš  {{ "label.editorFeaturesWarning" | translate }}
                    </div>
                  </div>
                  <br />

                  <br />

                  <!-- AUTOMATC TRANSLATION -->
                  <div
                    *ngIf="languagesLeftToAdd && languagesLeftToAdd.length > 0"
                    class="automatic-translation-container"
                  >
                    <mat-form-field>
                      <mat-label>{{
                        "label.translateInto" | translate
                      }}</mat-label>
                      <mat-select [(value)]="selectedNewLanguage">
                        <mat-option
                          *ngFor="let language of languagesLeftToAdd"
                          [value]="language"
                        >
                          {{
                            language.displayName[
                              _translationService.currentLanguage.value
                                ?.cultureCode
                            ]
                          }}
                        </mat-option>
                      </mat-select>
                    </mat-form-field>

                    <button
                      mat-raised-button
                      smaller-button
                      color="action"
                      type="button"
                      (click)="
                        addAutomaticalyTranslatedMultilingualItem(
                          selectedNewLanguage,
                          multilingualContentIndex
                        )
                      "
                    >
                      <mat-icon>translate</mat-icon>
                      <span>{{ "general.button.translate" | translate }}</span>
                    </button>
                  </div>
                </mat-expansion-panel>
              </div>

              <!-- ADDING NEW LANGUAGE -->
              <div
                *ngIf="languagesLeftToAdd && languagesLeftToAdd.length > 0"
                id="add-new-language-container"
              >
                <mat-form-field>
                  <mat-label>{{ "label.newLanguage" | translate }}</mat-label>
                  <mat-select [(value)]="selectedNewLanguage">
                    <mat-option
                      *ngFor="let language of languagesLeftToAdd"
                      [value]="language"
                    >
                      {{
                        language.displayName[
                          _translationService.currentLanguage.value?.cultureCode
                        ]
                      }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>

                <button
                  mat-raised-button
                  smaller-button
                  color="action"
                  (click)="addMultilingualFormItem(selectedNewLanguage)"
                  type="button"
                >
                  <mat-icon>add</mat-icon>
                  <span>{{ "general.button.add" | translate }}</span>
                </button>
              </div>
            </mat-card>
            <br />

            <mat-card id="general-content-card">
              <mat-card-header>
                <mat-card-title>{{
                  "label.generalContent" | translate
                }}</mat-card-title>
              </mat-card-header>
              <mat-divider [inset]="true"></mat-divider>
              <br />

              <mat-card-content>
                <!-- IMAGE/PDF -->
                <div id="image-container">
                  <div
                    id="image-preview-container"
                    *ngIf="
                      newFile ||
                      (news && news.attachment && !deleteCurrentlyAssignedFile)
                    "
                  >
                    <!-- PDF Preview -->
                    <pdf-viewer
                        *ngIf="
                          !newFile &&
                          news.attachment && news.attachment.fileExtension == 'pdf' &&
                          !deleteCurrentlyAssignedFile"
                        [src]="news.attachment.url"
                        [alt]="news.attachment.fileName"
                        [fit-to-page]="true"
                        [show-all]="false"
                        [page]="1">
                    </pdf-viewer>
                    <pdf-viewer
                        *ngIf="newFile && newFile.fileExtension == 'pdf' && newFile.base64"
                        [src]="newFile.base64"
                        [alt]="newFile.fileName"
                        [fit-to-page]="true"
                        [show-all]="false"
                        [page]="1">
                    </pdf-viewer>
                  
                    <!-- Image Preview -->
                    <img
                      *ngIf="
                        !newFile &&
                        news &&
                        news.attachment &&
                        news.attachment.fileExtension != 'pdf' &&
                        !deleteCurrentlyAssignedFile
                      "
                      [src]="news.attachment.url"
                      [alt]="news.attachment.fileName"
                    />
                    <img
                      *ngIf="newFile && newFile.fileExtension != 'pdf' && newFile.base64"
                      [src]="newFile.base64"
                      [alt]="newFile.fileName"
                    />
                  </div>

                  <button
                    mat-raised-button
                    smaller-button
                    color="action"
                    type="button"
                    (click)="imgFileInput.click()"
                  >
                    <mat-icon>publish</mat-icon>
                    <span
                      *ngIf="
                        newFile ||
                        (news &&
                          news.attachment &&
                          !deleteCurrentlyAssignedFile)
                      "
                      >{{ "general.button.changeImageOrPdf" | translate }}</span
                    >
                    <span
                      *ngIf="
                        !(
                          newFile ||
                          (news &&
                            news.attachment &&
                            !deleteCurrentlyAssignedFile)
                        )
                      "
                      >{{ "general.button.addAnImageOrPdf" | translate }}</span
                    >
                  </button>
                  <button
                    *ngIf="
                      news &&
                      news.attachment &&
                      (newFile || deleteCurrentlyAssignedFile)
                    "
                    mat-raised-button
                    smaller-button
                    color="warning"
                    type="button"
                    (click)="restoreFile()"
                  >
                    <mat-icon>reply</mat-icon>
                    <span>{{ "general.button.restoreImageOrPdf" | translate }}</span>
                  </button>
                  <button
                    *ngIf="
                      newFile ||
                      (news && news.attachment && !deleteCurrentlyAssignedFile)
                    "
                    mat-raised-button
                    smaller-button
                    color="danger"
                    type="button"
                    (click)="deleteFile()"
                  >
                    <mat-icon>delete</mat-icon>
                    <span>{{ "general.button.removeImageOrPdf" | translate }}</span>
                  </button>
                  <input
                    id="newsImage"
                    hidden
                    #imgFileInput
                    type="file"
                    name="image"
                    accept="image/png,image/jpg,image/jpeg,image/gif,application/pdf"
                    (change)="newFileHandler($event)"
                  />
                </div>
              </mat-card-content>
            </mat-card>
            <br />

            <mat-card id="layout-config-card">
              <mat-card-header>
                <mat-card-title style="display: flex; justify-content: space-between; align-items: center;">
                  {{ "label.layoutConfig" | translate }}
                  <!-- BOUTON CORRIGÉ - AJOUT DE TYPE="button" -->
                  <button 
                    mat-raised-button 
                    color="primary"
                    type="button"
                    class="preview-button"
                    [disabled]="!canPreview()"
                    (click)="openPreviewWithDeviceSelector(); $event.stopPropagation()"
                    matTooltip="Prévisualiser le rendu sur différents écrans">
                    <mat-icon>visibility</mat-icon>
                    Prévisualiser
                  </button>
                </mat-card-title>
              </mat-card-header>
             
              <mat-divider [inset]="true"></mat-divider>
              <br />

              <mat-card-content>
                <!-- IS VISIBLE -->
                <div id="layout-config-radio">
                  <mat-radio-group formControlName="layout">
                    <!-- LAYOUT OPTIONS -->
                    <div class="layout-radio-div">
                      <mat-radio-button
                        class="layout-radio"
                        [value]="newsLayout.horizontal"
                      >
                        <img
                          class="layout-icons"
                          src="../../../../../assets/images/horizontal-layout.png"
                        />
                        <requiredStar></requiredStar>
                      </mat-radio-button>
                      <mat-radio-button
                        class="layout-radio"
                        [value]="newsLayout.vertical"
                      >
                        <img
                          class="layout-icons"
                          src="../../../../../assets/images/vertical-layout.png"
                        />
                        <requiredStar></requiredStar>
                      </mat-radio-button>
                    </div>
                  </mat-radio-group>
                </div>
                <br />
                <div id="layout-content-div">
                  <span class="layout-box-number">1)</span>
                  <mat-form-field>
                    <mat-label
                      >{{ "label.box.size" | translate
                      }}<requiredStar> </requiredStar>
                    </mat-label>
                    <input
                      matInput
                      type="number"
                      formControlName="box1Size"
                      (change)="onBox1SizeChange()"
                    />
                  </mat-form-field>
                  <span class="percent-sign">%</span>
                  <mat-form-field class="layout-content-type">
                    <mat-label
                      >{{ "label.content.type" | translate
                      }}<requiredStar></requiredStar
                    ></mat-label>
                    <mat-select
                      formControlName="box1ContentType"
                      (selectionChange)="onBox1ContentTypeChange()"
                    >
                      <mat-option [value]="newsLayoutContentType.file">
                        {{ "label.content.file" | translate }}
                      </mat-option>
                      <mat-option [value]="newsLayoutContentType.text">
                        {{ "label.content.text" | translate }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
                <div id="layout-content-div">
                  <br />
                  <span class="layout-box-number">2)</span>
                  <mat-form-field>
                    <mat-label
                      >{{ "label.box.size" | translate
                      }}<requiredStar> </requiredStar>
                    </mat-label>
                    <input
                      matInput
                      type="number"
                      formControlName="box2Size"
                      (change)="onBox2SizeChange()"
                    />
                  </mat-form-field>
                  <span class="percent-sign">%</span>
                  <mat-form-field class="layout-content-type">
                    <mat-label
                      >{{ "label.content.type" | translate
                      }}<requiredStar></requiredStar
                    ></mat-label>
                    <mat-select
                      formControlName="box2ContentType"
                      (selectionChange)="onBox2ContentTypeChange()"
                    >
                      <mat-option [value]="newsLayoutContentType.file">
                        {{ "label.content.file" | translate }}
                      </mat-option>
                      <mat-option [value]="newsLayoutContentType.text">
                        {{ "label.content.text" | translate }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
              </mat-card-content>
            </mat-card>
            <br />

            <mat-card id="publication-card">
              <mat-card-header>
                <mat-card-title>{{
                  "label.publication" | translate
                }}</mat-card-title>
              </mat-card-header>
              <mat-divider [inset]="true"></mat-divider>
              <br />

              <mat-card-content>
                <!-- IS VISIBLE -->
                <div id="publication-radio">
                  <mat-radio-group formControlName="publication">
                    <!-- PUBLICATION DATE -->
                    <mat-radio-button [value]="publicationOptions.publish">
                      {{ "label.publishedFromOn" | translate }} &nbsp;
                      <mat-form-field (click)="pubDate.open()">
                        <mat-label
                          >{{ "label.publicationDate" | translate
                          }}<requiredStar> </requiredStar>
                        </mat-label>
                        <input
                          matInput
                          [matDatepicker]="pubDate"
                          formControlName="publicationDate"
                          required="false"
                        />
                        <mat-datepicker-toggle matSuffix [for]="pubDate">
                        </mat-datepicker-toggle>
                        <mat-datepicker #pubDate></mat-datepicker>
                      </mat-form-field>
                    </mat-radio-button>
                    <br />
                    <mat-radio-button [value]="publicationOptions.draft">
                      {{ "label.notPublishedDraft" | translate }}
                    </mat-radio-button>
                  </mat-radio-group>
                </div>
              </mat-card-content>
            </mat-card>
            <br />

            <mat-card id="expiration-card">
              <mat-card-header>
                <mat-card-title>{{
                  "label.expiration" | translate
                }}</mat-card-title>
              </mat-card-header>
              <mat-divider [inset]="true"></mat-divider>
              <br />
              <mat-card-content>
                <!-- IS VISIBLE -->
                <div id="expiration-radio">
                  <mat-radio-group formControlName="expiration">
                    <!-- EXPIRATION DATE -->
                    <mat-radio-button [value]="expirationOptions.expire">
                      {{ "label.publicationExpireOn" | translate }} &nbsp;
                      <mat-form-field (click)="expDate.open()">
                        <mat-label
                          >{{ "label.publicationExpirationDate" | translate }}
                        </mat-label>
                        <input
                          matInput
                          [matDatepicker]="expDate"
                          formControlName="expirationDate"
                          required="false"
                        />
                        <mat-datepicker-toggle matSuffix [for]="expDate">
                        </mat-datepicker-toggle>
                        <mat-datepicker #expDate></mat-datepicker>
                      </mat-form-field>
                    </mat-radio-button>
                    <br />
                    <mat-radio-button [value]="expirationOptions.persist">
                      {{ "label.doesNotExpire" | translate }}
                    </mat-radio-button>
                  </mat-radio-group>
                </div>
              </mat-card-content>
            </mat-card>
            <br />

            <mat-card id="metadata-card">
              <mat-card-header>
                <mat-card-title
                  >{{ "label.metadata" | translate
                  }}<span class="card-title-infos"
                    >({{ "label.metadata.infos" | translate }})</span
                  ></mat-card-title
                >
              </mat-card-header>
              <mat-divider [inset]="true"></mat-divider>
              <br />
              <mat-card-content>
                <!-- DESCRIPTION -->
                <div id="description-container">
                  <mat-form-field>
                    <mat-label>{{ "label.description" | translate }}</mat-label>
                    <input
                      matInput
                      id="description"
                      type="text"
                      formControlName="description"
                    />
                    <mat-error
                      *ngIf="editNewsForm.controls['description'].invalid"
                    >
                      <div
                        *ngIf="
                          editNewsForm.controls['description'].errors.maxlength
                        "
                      >
                        {{ "label.fieldMax250Characters" | translate }}
                      </div>
                    </mat-error>
                  </mat-form-field>
                </div>

                <!-- NOTIFICATION INFO -->
                <ng-container
                  *ngIf="
                    news &&
                    (news.usersNotified ||
                      (!news.usersNotified &&
                        news.isVisible &&
                        isTodayOrBefore(news.publicationDate)))
                  "
                >
                  <br />
                  <div id="notification-container">
                    <ng-container *ngIf="news.usersNotified"
                      ><p class="notification-info">
                        {{ "metadata.notificationsSentOn" | translate
                        }}{{ news.usersNotified | vesactDate | async }}
                      </p>
                      <button
                        mat-raised-button
                        color="warning"
                        type="button"
                        (click)="resetNotificationFlag()"
                        class="reset-notification-button"
                      >
                        <mat-icon>notifications</mat-icon>
                        {{ "general.button.resetNotification" | translate }}
                      </button>
                    </ng-container>
                    <ng-container
                      *ngIf="
                        !news.usersNotified &&
                        news.isVisible &&
                        isTodayOrBefore(news.publicationDate) &&
                        isForApp()
                      "
                    >
                      <p class="notification-info">
                        {{ "metadata.notificationsNotYetSent" | translate }}
                      </p></ng-container
                    >
                    <ng-container
                      *ngIf="
                        !news.usersNotified &&
                        news.isVisible &&
                        isTodayOrBefore(news.publicationDate) &&
                        !isForApp()
                      "
                    >
                      <p class="notification-info">
                        {{ "metadata.notificationsNotSupported" | translate }}
                      </p></ng-container
                    >
                  </div>
                </ng-container>

                <!-- LAST EDITOR -->
                <ng-container *ngIf="news?.lastEditor">
                  <br />
                  <div id="last-edit-container">
                    <p class="last-editor">
                      {{ "metadata.lastEditor" | translate
                      }}{{ news.lastEditor.displayName }}
                    </p>
                    <p class="last-edit-date">
                      {{ "metadata.lastEditDate" | translate
                      }}{{ news.lastEditDate | vesactDateFromNow | async }}
                    </p>
                  </div>
                </ng-container>
              </mat-card-content>
            </mat-card>
          </div>

          <!-- CHANNEL AND INFOSCREEN ASSIGNMENT COLUMN -->
          <div id="news-edit-right-column">
            <!-- CHANNEL -->
            <mat-card
              id="channels-card"
              *ngIf="tenantService.currentTenant.appName"
            >
              <mat-card-header>
                <mat-card-title>{{
                  "label.channels" | translate
                }}</mat-card-title>
              </mat-card-header>
              <mat-divider [inset]="true"></mat-divider>
              <br />

              <mat-card-content>
                <div class="channels-container">
                  <div class="channel">
                    <mat-checkbox formControlName="isForInfoscreens">
                      {{ "label.infoscreens" | translate }}
                    </mat-checkbox>
                  </div>
                  <div class="channel">
                    <mat-checkbox formControlName="isForApp">
                      {{ tenantService.currentTenant.appName }}
                    </mat-checkbox>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>

            <!-- CATEGORY ASSIGNMENT -->
            <categories-input-card
              id="categories-card"
              [selectedCategories]="categories"
              [allCategories]="allCategories"
            ></categories-input-card>

            <!-- INFOSCREEN ASSIGNMENT -->
            <mat-card id="infoscreens-card">
              <mat-card-header>
                <mat-card-title>{{
                  "label.infoscreens" | translate
                }}</mat-card-title>
              </mat-card-header>
              <mat-divider [inset]="true"></mat-divider>
              <br />

              <mat-card-content>
                <div
                  *ngFor="let group of infoscreenGroups"
                  class="infoscreen-group"
                >
                  <mat-checkbox
                    [checked]="isGroupChecked(group.id)"
                    [indeterminate]="isGroupIndeterminate(group.id)"
                    (change)="groupChange(group.id, $event.checked)"
                  >
                    {{ group.name }}
                  </mat-checkbox>
                  <div
                    *ngFor="let infoscreen of getInfoscreensOfGroup(group.id)"
                    class="infoscreen"
                  >
                    <mat-checkbox
                      [checked]="isInfoscreenChecked(infoscreen.id)"
                      (change)="infoscreenChange(infoscreen.id, $event.checked)"
                      [matTooltip]="infoscreen.description"
                      matTooltipShowDelay="400"
                      matTooltipPosition="left"
                    >
                      {{ infoscreen.displayName }}
                    </mat-checkbox>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- LOADING -->
  <div *ngIf="isLoading" class="fullPage-loadingSpinner-wrapper">
    <loading-spinner></loading-spinner>
  </div>
</div>